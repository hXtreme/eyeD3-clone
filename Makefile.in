#
#  Copyright (C) 2002-2011  Travis Shirk <travis@pobox.com>
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
SHELL:=/bin/bash
DIST_NAME=@PACKAGE_TARNAME@-@PACKAGE_VERSION@
DIST_TAR=${DIST_NAME}.tar
DIST_GZ=${DIST_TAR}.gz
DIST_WWW=${DIST_NAME}-www.tar.gz
PYTHON=@PYTHON@
EBUILD_VERSION=@EBUILD_VERSION@

# FIXME: I think this is an rpm artifact. Ebuilds pass DESTDIR so no translation
# is necessary. Remve?
ifdef BUILD_ROOT
  DESTDIR=${BUILD_ROOT}
endif
ifdef DESTDIR
  SETUP_ARGS=--root ${DESTDIR}
endif
prefix=@prefix@
exec_prefix:=@exec_prefix@
bindir:=$(subst //,/,${DESTDIR}/@bindir@)
datarootdir:=$(subst //,/,${DESTDIR}/@datarootdir@)
mandir:=$(subst //,/,${DESTDIR}/@mandir@)
datadir:=$(subst //,/,${DESTDIR}/@datadir@)
docdir:=$(subst //,/,${DESTDIR}/@datadir@/doc/${DIST_NAME})
# Redefine these
prefix:=$(subst //,/,${DESTDIR}/${prefix})
exec_prefix:=$(subst //,/,${DESTDIR}/${exec_prefix})

DOCS_BUILD_D=doc/.build

.PHONY: all
all: module

.PHONY: module
module:
	${PYTHON} setup.py build

.PHONY: install
install:
	${PYTHON} setup.py install ${SETUP_ARGS} --prefix=${prefix}

	install -m 755 -d ${bindir}
	install -m 755 bin/eyeD3 ${bindir}

	install -m 755 -d ${docdir}
	# FIXME
	#install -m 644 README ${docdir}
	#install -m 644 AUTHORS ${docdir}
	install -m 644 COPYING ${docdir}
	gzip -f -9 ${docdir}/COPYING
	install -m 644 ChangeLog ${docdir}
	gzip -f -9 ${docdir}/ChangeLog

	# FIXME
	# FIXME: conditionalize this with a USE=doc->configure var
	#install -m 755 -d ${docdir}/api

	# FIXME
	#install -m 755 -d ${mandir}/man1
	#install -m 644 doc/eyeD3.1 ${mandir}/man1
	#gzip -f -9 ${mandir}/man1/eyeD3.1

	# FIXME
	#-${MAKE} -C po DESTDIR=${DESTDIR} install

.PHONY: clean
clean:
	-rm -rf build
	find . -name \*.pyc -exec rm '{}' \;
	-rm -rf eyeD3.egg-info

.PHONY: dist-clean
dist-clean: clean test-clean
	-rm -rf autom4te*.cache ${DIST_NAME} ${DIST_GZ} ${DIST_WWW} ${DIST_WWW}
	-rm doc/eyeD3.1.gz
	-rm -f config.*
	-rm -rf src/eyed3/info.py
	-find . -name \*.pyc -exec rm '{}' \;
	-rm Makefile
	-rm tags
	-rm pylint-report.html
	#-${MAKE} -C po distclean

.PHONY: maintainer-clean
maintainer-clean: docs-clean
	-rm -f configure src/config.h.in
	-rm doc/eyeD3.1
	${MAKE} dist-clean

.PHONY: dist
dist: docs dist-clean
	mkdir ${DIST_NAME}
	cp ChangeLog AUTHORS COPYING README TODO INSTALL ${DIST_NAME}
	# FIXME: not sure if acsite needs to go if configure is processed
	cp acsite.m4 configure setup.py Makefile.in ${DIST_NAME}

	mkdir ${DIST_NAME}/etc
	cp etc/gentoo/eyeD3-${EBUILD_VERSION}.ebuild ${DIST_NAME}/etc
	mkdir ${DIST_NAME}/src
	cp -r src/eyed3 ${DIST_NAME}/src
	mkdir ${DIST_NAME}/bin
	cp bin/eyeD3 ${DIST_NAME}/bin
	# FIXME
	#mkdir ${DIST_NAME}/doc
	#cp doc/eyeD3.1.in ${DIST_NAME}/doc

	# FIXME
	#cp -r ./po ${DIST_NAME}

	find ${DIST_NAME} -type d -name .svn -print | xargs rm -rf
	tar cf ${DIST_TAR} ${DIST_NAME}
	gzip ${DIST_TAR}
	rm -rf ${DIST_NAME}
	./autogen.sh

.PHONY: release
release: dist www sloccount
	# Re-bootstap to undo dist-clean
	./autogen.sh > /dev/null 2>&1


.PHONY: changelog
changelog:
	hg log --style=changelog . >| ChangeLog
	   
.PHONY: tags
tags: 
	@if test -f tags; then \
	   rm tags; \
        fi
	ctags -R --exclude='tmp/*' --exclude='build/*'

.PHONY: docs
docs:
	# FIXME
	#${MAKE} -C ./doc html
	@echo "Docs: file://`pwd`/${DOCS_BUILD_D}/html/index.html"

.PHONY: docs-clean
docs-clean:
	-rm -rf ${DOCS_BUILD_D}/*
	# FIXME
	#${MAKE} -C ./doc clean

.PHONY: www
www:
	-rm -rf ./www
	-mkdir -p www/eyeD3/releases
	-mkdir www/eyeD3/releases/gentoo
	cp ChangeLog COPYING TODO www/eyeD3
	cp ${DIST_GZ} www/eyeD3/releases
	cp etc/gentoo/eyeD3-${EBUILD_VERSION}.ebuild www/eyeD3/releases/gentoo
	tar czvf ${DIST_WWW} www
	rm -rf www

.PHONY: push-www
push-www:
	scp ${DIST_WWW} nicfit:.
	ssh nicfit 'tar xzvf ${DIST_WWW}'

.PHONY: sloccount
sloccount:
	sloccount ./src
	sloccount --cached --details ./src

.PHONY: test-dist
test-dist:
	-${MAKE} maintainer-clean
	./autogen.sh
	${MAKE} dist

	test -d ./tmp || mkdir tmp
	test -d ./tmp/install || mkdir tmp/install
	-rm -rf ./tmp/${DIST_NAME}
	-rm -rf ./tmp/install/*
	tar xzvf ${DIST_GZ} -C ./tmp

	cd ./tmp/${DIST_NAME} && ./configure --prefix=${CURDIR}/tmp/install
	${MAKE} -C ./tmp/${DIST_NAME}
	${MAKE} -C ./tmp/${DIST_NAME} install

.PHONY: test
test: all
	nosetests --verbosity=3 --detailed-errors ${NOSE_OPTS} \
	    --with-coverage --cover-erase --cover-package=eyed3 \
	    --cover-html --cover-html-dir=build/test/coverage\
	    src/test
	@echo "Coverage: file://${CURDIR}/build/test/coverage/index.html"

.PHONY: test-clean
test-clean:
	-find ./src/test -name \*.pyc -exec rm '{}' \;
	-rm -rf build/test/html
	-rm -rf .coverage
	-find . -name \*,cover -exec rm '{}' \;

PYLINT_OPTS=
.PHONY: pylint
pylint:
	pylint --rcfile=etc/pylint.conf \
	       ${PYLINT_OPTS} eyed3 > pylint-report.html
